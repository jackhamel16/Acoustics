using Test

include("../../src/mesh.jl")

@testset "mesh tests" begin
    @testset "computeCentroid tests" begin
        zero_vertices = zeros(3,3)
        @test computeCentroid(zero_vertices) == [0.,0.,0.]
        ones_vertices = ones(3,3)
        @test computeCentroid(ones_vertices) == [1,1,1]
        vertices=Array{Float64,2}(undef,3,3)
        for i in 1:3, j in 1:3
            vertices[i,j] = (2*i-1)*(j-2.5)
        end
        centroid = [-4.5, -1.5, 1.5]
        @test computeCentroid(vertices) == centroid
    end
    @testset "reshapeMeshArray tests" begin
        @test reshapeMeshArray([1,2,3,4,5,6], 2) == [i*2+j for i in 0:2, j in 1:2]
        @test typeof(reshapeMeshArray([1,2,3,4,5,6], 2, Float64)) == Array{Float64, 2}
        @test typeof(reshapeMeshArray([1.,2.,3.,4.,5.,6.], 3)) == typeof([i*3.0+j for i in 0:1, j in 1:3])
    end
    @testset "buildPulseMesh tests" begin
        num_elements = 2
        nodes_solution = [0.0 0.0 0.0; 0.0 1.0 0.0; 1.0 1.0 0.0; 1.0 0.0 0.0]
        elements_solution = [2 1 4; 2 4 3]

        test_mesh_filename = "examples/test/rectangle_plate.msh"
        test_pulse_mesh = buildPulseMesh(test_mesh_filename)

        @test test_pulse_mesh.num_elements == num_elements
        @test test_pulse_mesh.nodes == nodes_solution
        @test test_pulse_mesh.elements == elements_solution

        elements_solution2 =  [4 1 2; 4 2 5; 5 2 6; 2 3 6;
                               7 4 8; 8 4 5; 8 5 6; 8 6 9]
        test_mesh_filename2 = "examples/test/rectangle_plate_8elements_symmetric.msh"
        test_pulse_mesh2 = buildPulseMesh(test_mesh_filename2)

        @test test_pulse_mesh2.elements == elements_solution2

        # Testing locations of nodes and nodes comprising elements of a sphere
        test_mesh_filename3 = "examples/test/sphere_1m.msh"
        test_pulse_mesh3 = buildPulseMesh(test_mesh_filename3)
        nodes_solution = [6.123031769111886e-17 -1.499660721822137e-32 1
                            6.123031769111886e-17 -1.499660721822137e-32 -1
                            0.3090169943749472 -7.568483495013084e-17 -0.9510565162951536
                            0.5877852522924729 -1.439611109280903e-16 -0.8090169943749476
                            0.8090169943749473 -1.981454703323686e-16 -0.5877852522924734
                            0.9510565162951535 -2.32933970539844e-16 -0.3090169943749476
                            1 -2.449212707644755e-16 -2.449212707644755e-16
                            0.9510565162951536 -2.329339705398441e-16 0.3090169943749472
                            0.8090169943749476 -1.981454703323686e-16 0.5877852522924729
                            0.5877852522924734 -1.439611109280904e-16 0.8090169943749472
                            0.3090169943749477 -7.568483495013096e-17 0.9510565162951535
                            0.391496540662427 -0.3014462638232502 -0.8694024434497272
                            0.3889462625001999 0.2341541772868659 0.8910065241883678
                            0.951848879214271 -0.2683431703073605 -0.148241876971155
                            0.6853224052773846 -0.292820802930966 0.6667752081441575
                            0.8657568545927664 0.2714089918825375 0.4204785700258031
                            0.8621574109319818 0.2714058744096293 -0.4278124006045245
                            0.4371526982420634 0.2698172279021051 -0.857960478079793
                            0.1506325540503649 -0.2698172279019947 0.9510565162951921
                            0.6808812905080637 -0.269817227902308 -0.6808812905075214
                            0.4739481947789234 -0.5293924234068549 -0.7036453444066955
                            0.7041982438596454 -0.5188857457648071 -0.4846260580974693
                            0.482860198413478 -0.7417399620374476 -0.4654759472892046
                            0.6803497399228282 -0.6961159003600592 -0.2292310726163536
                            0.4269018964625456 -0.8830861588370303 -0.1947141670940795
                            0.6078566966193275 -0.7925176125263261 0.0492551541527459
                            0.3192869999066135 -0.9434822523650261 0.08886535411987787
                            0.4631210832028053 -0.8196729675532841 0.3371277036309135
                            0.1668291135951629 -0.9185039722168548 0.3584947696674411
                            0.2963764685572976 -0.7492175201159263 0.5923124989706419
                            -0.01151621271388377 -0.8047852501306865 0.5934543605171479
                            0.7102310226077344 -0.6439167347748618 0.284505067094511
                            0.6808812905078324 0.2698172279020885 0.6808812905078397
                            0.6898941823453502 0.5223093169313345 0.5012374632973512
                            0.8354836676815346 0.5004992659428419 0.2268645539260983
                            0.1108658735362036 -0.5979796858092796 0.7938066851850579
                            0.4059825621538238 -0.5243751564267819 0.7484710111616912
                            0.4738980672274495 0.4992005973793977 0.7254098051819675
                            0.4566416017550372 0.730278646609698 0.5081058411910867
                            0.9536711670372647 -0.2618038116448057 0.1482230392686389
                            0.8408353902112926 -0.541018680437651 0.01716490564279731
                            0.8676742306612654 -0.2716511003824183 -0.4163497437340419
                            0.1506325540504112 0.2698172279021036 -0.9510565162951539
                            0.6741037745055017 0.2630486925024995 -0.6902097409991843
                            0.6846144597997368 0.5194986425839152 -0.5112965888665639
                            0.207171921853724 -0.8910977872583709 -0.4037629605829013
                            -0.1449408526526504 -0.929414586265331 0.3393827869376499
                            0.2021926803898415 -0.5429832497446559 -0.8150382264001511
                            0.8297746977887017 0.5064666913657264 -0.2344470973305553
                            0.620507897993787 0.7316669195114126 -0.2821940244229351
                            0.4405911090070682 0.7120882945736523 -0.5466349196631232
                            0.3478494759222637 0.8868147624225128 -0.3042372745902591
                            0.1536758657290714 0.8327286025426957 -0.5319274412922402
                            0.04498669348038323 0.9600821103420575 -0.2760770523075824
                            -0.1575369519633497 0.8567850327951999 -0.491020891963087
                            -0.2599496476368965 0.9429074378692498 -0.208210816972366
                            -0.458127706046136 0.8052830163813446 -0.3763485996794305
                            -0.04999815982728167 0.998579120186614 0.01843704806127006
                            -0.3193806648843877 -0.7736563704147051 0.5472219032666282
                            -0.4411575060193114 -0.8555630943549802 0.2709092956333399
                            -0.5379039376782631 0.8368487079319646 -0.1017034604269707
                            -0.7105486922719507 0.6546039157553678 -0.2580974029089796
                            -0.7568761073217597 0.6531501442115223 0.02309647769526182
                            -0.8878442889631053 0.4309343740108812 -0.1613322157891843
                            -0.900014019784762 0.4090412595849725 0.150532428891628
                            -0.7887446790237519 0.408450166363673 -0.4594021037274497
                            -0.7278397711607842 0.6043963774523199 0.3239664896854765
                            -0.9392815164436273 0.1786421740522192 -0.2929798739115989
                            -0.831437230114468 0.3362564043040095 0.442316360701387
                            -0.799532102494897 0.1146814078101856 -0.5895732285159861
                            -0.8978238240410189 -0.1297440388867529 -0.4208073969855025
                            -0.6185266740137043 0.5068728404409334 0.6004204170053553
                            -0.1381278727266953 -0.4143274816563114 0.8995851425631355
                            -0.6024872384094997 -0.6616374909795513 0.4463686347448473
                            -0.7184611738704324 -0.1757583371594753 -0.6729952069366145
                            -0.7762073664701102 -0.4125200640005383 -0.4767906469662839
                            -0.960841036489871 0.1133726784406381 0.2528460764581213
                            -0.3342970541362362 0.6669189118140502 -0.6659314113785274
                            -0.6841300134771932 0.2164406250204378 0.6965052623637942
                            0.2150620409557342 0.6738945711241914 0.7068340862955721
                            -0.925784466399403 -0.3379317127308222 -0.1694853365468106
                            -0.5820896332424542 0.07019926284965365 -0.8100887126525281
                            -0.4534997053064414 0.3856782126587358 0.8034863617805431
                            -0.5593500129107511 -0.4437770273981459 -0.7001353533499132
                            -0.5856907500066832 -0.6607543575336935 -0.4694358575533454
                            -0.4936021805890591 0.7440636086046404 0.4502513005733203
                            -0.2520317821155719 -0.9655776333114671 0.06434139299296199
                            -0.477602768961559 0.06493793723528778 0.8761727337619435
                            -0.7057058110743027 -0.09381730085060205 0.7022660623133288
                            -0.3380641081994786 -0.6626496523236398 -0.6682874359305661
                            -0.3391866535712955 -0.8447747559566202 -0.4138937372533423
                            -0.2913090156763931 -0.419613266934895 -0.8596881781191803
                            0.5070244543149978 0.8614698921523507 -0.02821041725313407
                            -0.6818600116196797 -0.7096780766529218 0.1772680232648286
                            -0.8210187374962715 -0.4792872111235142 0.3101805956752813
                            0.1790835476114246 0.8676345252994708 0.4638312338375549
                            -0.06464537820434313 0.7825162865518172 0.6192650776186011
                            -0.02239484433456359 0.589635271470399 0.8073591007632599
                            -0.2708925854212321 0.249120224391852 0.9298152079648696
                            -0.4517659826706595 -0.5410907014295032 0.7093154091997027
                            0.2357947285165994 0.6588246357867268 -0.714388511444767
                            -0.5605025443645663 -0.7988795189527388 -0.2182393455788578
                            -0.07405122840043875 0.5054162015137647 -0.8596923163666078
                            -0.1640912914753794 0.2167049808141461 -0.9623476499437627
                            -0.1112712207580752 0.9340633451718918 0.3393293129650062
                            -0.2112783172059116 -0.153382003670688 0.965316235038344
                            -0.07226205580291341 -0.8194255120417741 -0.5686123684076992
                            -0.4565087744430909 -0.2464928860789172 0.854892388531418
                            -0.7037714900177228 -0.3968250268265538 0.5892669920522777
                            -0.8761586809986346 -0.1907345976468375 0.4426807867653981
                            -0.9586456133982627 -0.2476101706143887 0.1403131901161891
                            -0.9956992512912768 -0.03220668185989602 -0.0868661649986122
                            -0.3840701949162078 0.4294194126878057 -0.8173671472379387
                            -0.5825157842085857 0.474989399425376 -0.6595911093862447
                            -0.085039835111847 -0.9411648915609139 -0.3270731926301561
                            -0.03401751743265797 0.7388296699125473 -0.6730330804385736
                            0.3987629806797781 0.8791155401482501 0.2610439662379297
                            0.8618689795326703 -0.2596495829544095 0.4356190493893888
                            0.04996630336553891 -0.2831631207851517 -0.9577692914033089
                            0.1580682296303348 -0.9753529709663573 -0.1539513455888969
                            -0.3045095401615537 0.6387334073910216 0.7066070861753754
                            0.9559172227198367 0.2515940624230973 -0.1514024143170667
                            0.6389082562301107 0.7250209783930015 0.2571785780562871
                            0.7537113685284266 0.6571062038930877 -0.01142846254848308
                            -0.763483759604807 -0.5942881401915704 -0.2528124902914287
                            -0.3313218691886898 0.9403034706117677 0.07781517944962493
                            -0.5558599848134665 0.810911650501755 0.1828714640497321
                            -0.05423488905810839 -0.6113366436913393 -0.7895100283651013
                            -0.2330245681724498 -0.1115831027047563 -0.9660480121706286
                            -0.4912556019442689 -0.1790819517314396 -0.8524069381008301
                            0.2310222132868085 0.9716074546594285 -0.05106555608520152
                            0.02707204122480902 -0.9934429436076876 0.1110775511974193
                            0.55219172982272 -0.6317953201730713 0.543984344372886
                            0.957608126766411 0.254812762028322 0.1343768278328633
                            0.4373988073909277 -0.2678750643047951 0.8584434944809681
                            -0.845795982993327 -0.5329348769736902 0.02468951310555208
                            -0.178993591985866 -0.6597352878365071 0.7298702925940187
                            0.4872241408381434 0.4839639116483289 -0.7269054744645836
                            -0.8567881851877382 0.0797027033264673 0.5094717703711904
                            0.22448946903172 -0.7446103233544852 -0.6286174867499196
                            0.2449429713396806 0.4801747253110348 0.8422797480432263
                            0.142459178215329 0.9672505177272912 0.2100757446696319
                            -0.6219385492950057 0.6268576496856358 -0.4692994011624397
                            0.8362988550846341 -0.4819860354861209 -0.2613306078141288
                            -0.01530261653635747 0.2600757343358739 0.9654669555902973
                            0.7574774460966084 -0.4690936406863243 0.4540694604601914
                            -0.9709216997116044 0.238314335820335 -0.0227448977056791
                            -0.5168882199263231 -0.8559985806310708 0.009643550123747983
                            -0.3156607905268609 -0.9342998640356082 -0.1656563593316042
                            0.8971172723943803 0.4417376955079984 -0.006957581400895099
                            -0.223201958112047 0.4926358694147855 0.8411247149269164
                            0.2777458608908699 0.4473740753297031 -0.8501256809912772
                            -0.337136215794451 0.07345716800403509 -0.938585753391039
                            -0.3656113625927001 0.8748998732552989 0.3176138273453643
                            0.8505430846253785 -0.448281478612903 0.2749912310030551
                            -0.06811456524291518 -0.9926157628894523 -0.1003710778320087
                            -0.6413204769395399 0.2599514480594423 -0.7218956230022733
                            -0.4382998732858046 0.2209182761000501 -0.871256756853357
                            -0.2796332244264941 0.8044623969411522 0.5240663237649774
                            -0.703159761651782 -0.7088287043325494 -0.0559304703006196]
        elements_solution = [13 1 145 106
                                14 81 112 71
                                15 88 108 106
                                16 77 111 110
                                17 36 37 19
                                18 111 112 81
                                19 37 133 15
                                20 71 112 68
                                21 88 106 99
                                22 119 128 92
                                23 73 108 100
                                24 4 20 12
                                25 141 145 13
                                26 106 108 73
                                27 77 112 111
                                28 133 146 15
                                29 20 21 12
                                30 129 153 104
                                31 26 41 32
                                32 108 109 100
                                33 92 129 119
                                34 89 109 108
                                35 24 41 26
                                36 72 121 86
                                37 37 135 19
                                38 19 73 36
                                39 12 119 3
                                40 128 140 107
                                41 58 126 105
                                42 3 119 2
                                43 117 123 93
                                44 123 124 93
                                45 100 137 73
                                46 33 38 13
                                47 106 145 99
                                48 10 33 13
                                49 83 121 72
                                50 48 128 119
                                51 4 12 3
                                52 93 131 117
                                53 107 140 46
                                54 103 113 78
                                55 110 139 77
                                56 43 104 103
                                57 89 110 109
                                58 78 116 103
                                59 15 135 37
                                60 20 22 21
                                61 21 48 12
                                62 81 136 111
                                63 103 152 43
                                64 101 152 103
                                65 19 106 73
                                66 131 142 117
                                67 113 157 114
                                68 114 143 78
                                69 78 143 57
                                70 82 153 130
                                71 113 158 157
                                72 22 23 21
                                73 48 119 12
                                74 126 154 105
                                75 113 114 78
                                76 55 116 78
                                77 22 24 23
                                78 105 142 58
                                79 7 14 6
                                80 24 25 23
                                81 25 46 23
                                82 24 26 25
                                83 48 140 128
                                84 26 27 25
                                85 26 28 27
                                86 28 29 27
                                87 26 32 28
                                88 28 30 29
                                89 30 31 29
                                90 31 47 29
                                91 30 36 31
                                92 30 37 36
                                93 31 59 47
                                94 59 60 47
                                95 59 74 60
                                96 60 87 47
                                97 74 94 60
                                98 59 100 74
                                99 55 78 57
                                100 84 85 76
                                101 74 95 94
                                102 69 79 72
                                103 100 109 74
                                104 75 84 76
                                105 51 52 50
                                106 84 90 85
                                107 45 51 50
                                108 72 86 67
                                109 52 93 50
                                110 51 53 52
                                111 79 89 88
                                112 10 15 9
                                113 84 92 90
                                114 51 101 53
                                115 92 128 90
                                116 84 130 92
                                117 5 20 4
                                118 3 18 4
                                119 2 43 3
                                120 8 40 7
                                121 8 16 9
                                122 90 91 85
                                123 9 33 10
                                124 70 75 71
                                125 75 76 71
                                126 69 72 67
                                127 70 71 68
                                128 65 77 69
                                129 1 19 11
                                130 65 69 67
                                131 66 70 68
                                132 5 44 17
                                133 65 67 63
                                134 5 17 6
                                135 66 68 64
                                136 45 50 49
                                137 91 102 85
                                138 62 66 64
                                139 64 65 63
                                140 57 61 56
                                141 89 108 88
                                142 56 58 54
                                143 62 64 63
                                144 45 49 17
                                145 90 107 91
                                146 57 62 61
                                147 44 45 17
                                148 62 63 61
                                149 76 81 71
                                150 55 57 56
                                151 88 99 83
                                152 79 88 83
                                153 55 56 54
                                154 70 82 75
                                155 79 83 72
                                156 53 55 54
                                157 53 54 52
                                158 98 145 141
                                159 98 141 80
                                160 96 105 97
                                161 97 98 80
                                162 96 97 80
                                163 39 96 80
                                164 39 80 38
                                165 92 130 129
                                166 34 39 38
                                167 46 115 107
                                168 7 40 14
                                169 11 135 10
                                170 14 42 6
                                171 16 35 34
                                172 34 38 33
                                173 93 124 50
                                174 50 124 49
                                175 110 111 95
                                176 40 41 14
                                177 89 139 110
                                178 66 157 70
                                179 3 43 18
                                180 16 33 9
                                181 4 44 5
                                182 8 118 40
                                183 10 135 15
                                184 19 135 11
                                185 121 159 86
                                186 9 118 8
                                187 16 34 33
                                188 6 42 5
                                189 114 157 66
                                190 80 141 38
                                191 75 130 84
                                192 90 128 107
                                193 74 109 95
                                194 17 122 6
                                195 49 122 17
                                196 15 118 9
                                197 39 117 96
                                198 2 104 43
                                199 8 134 16
                                200 111 136 95
                                201 95 136 94
                                202 6 122 7
                                203 16 134 35
                                204 20 42 22
                                205 32 133 28
                                206 18 44 4
                                207 29 132 27
                                208 41 155 32
                                209 109 110 95
                                210 45 138 51
                                211 102 125 85
                                212 34 123 39
                                213 46 120 115
                                214 63 127 61
                                215 51 138 101
                                216 44 138 45
                                217 35 124 123
                                218 67 127 63
                                219 58 131 54
                                220 54 131 52
                                221 7 134 8
                                222 56 126 58
                                223 52 131 93
                                224 86 127 67
                                225 39 123 117
                                226 119 129 2
                                227 85 125 76
                                228 61 126 56
                                229 5 42 20
                                230 73 137 36
                                231 10 13 11
                                232 59 137 100
                                233 36 137 31
                                234 35 123 34
                                235 27 120 25
                                236 47 132 29
                                237 27 132 120
                                238 24 144 41
                                239 28 133 30
                                240 125 136 81
                                241 76 125 81
                                242 112 147 68
                                243 2 129 104
                                244 104 113 103
                                245 122 134 7
                                246 23 140 21
                                247 103 116 101
                                248 31 137 59
                                249 97 121 98
                                250 77 147 112
                                251 25 120 46
                                252 87 132 47
                                253 79 139 89
                                254 77 139 69
                                255 30 133 37
                                256 107 115 91
                                257 96 142 105
                                258 130 153 129
                                259 21 140 48
                                260 46 140 23
                                261 53 116 55
                                262 14 144 42
                                263 61 127 126
                                264 65 147 77
                                265 68 147 64
                                266 82 130 75
                                267 94 148 60
                                268 82 158 153
                                269 69 139 79
                                270 38 141 13
                                271 99 151 83
                                272 42 144 22
                                273 40 155 41
                                274 117 142 96
                                275 22 144 24
                                276 41 144 14
                                277 94 160 148
                                278 101 116 53
                                279 35 150 124
                                280 1 106 19
                                281 58 142 131
                                282 18 138 44
                                283 66 143 114
                                284 124 150 49
                                285 115 149 91
                                286 115 156 149
                                287 105 159 97
                                288 64 147 65
                                289 91 149 102
                                290 15 146 118
                                291 60 148 87
                                292 83 151 121
                                293 125 160 136
                                294 32 146 133
                                295 62 143 66
                                296 98 151 145
                                297 122 150 134
                                298 118 155 40
                                299 127 154 126
                                300 70 157 82
                                301 57 143 62
                                302 134 150 35
                                303 148 160 102
                                304 86 154 127
                                305 97 159 121
                                306 49 150 122
                                307 132 156 120
                                308 149 156 87
                                309 120 156 115
                                310 43 152 18
                                311 104 158 113
                                312 138 152 101
                                313 136 160 94
                                314 102 160 125
                                315 145 151 99
                                316 87 156 132
                                317 154 159 105
                                318 102 149 148
                                319 121 151 98
                                320 148 149 87
                                321 18 152 138
                                322 32 155 146
                                323 146 155 118
                                324 153 158 104
                                325 157 158 82
                                326 86 159 154
                                327 11 13 1
                                328 13 145 1]

        @test isapprox(test_pulse_mesh3.nodes, nodes_solution, rtol=1e-14)
        @test isapprox(test_pulse_mesh3.elements, elements_solution[:,2:4], rtol=1e-14)
    end
    @testset "barycentric2Cartesian tests" begin
        nodes = [0.0 0.0 0.0; 0.0 1.0 1.0; 1.0 0.0 1.0]
        barycentric_coords = [1.0, 0.0, 0.0]
        cartesian_coords = [0.0, 0.0, 0.0]
        @test barycentric2Cartesian(nodes, barycentric_coords) == cartesian_coords
        barycentric_coords = [0.5, 0.5, 0.0]
        cartesian_coords = [0.0, 0.5, 0.5]
        @test barycentric2Cartesian(nodes, barycentric_coords) == cartesian_coords
        nodes = [0.0 -1.0 1.0; -2.0 0.0 0.0; 2.0 0.0 -0.5]
        barycentric_coords = [0.6, 0.6, -0.2]
        cartesian_coords = [-1.6, -0.6, 0.7]
        @test barycentric2Cartesian(nodes, barycentric_coords) == cartesian_coords
    end
end
